<!DOCTYPE html>
<html>

<head>

  <script src="https://www.gstatic.com/firebasejs/7.8.1/firebase-app.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>


<body id="background">
  <div class="jumbotron jumbotron-fluid">
    <div class="container">
      <h1 class="header">The Savvy Traveler</h1>
      <p class="lead">
        Enter your destination and see the possibilities...
      </p>
    </div>
  </div>
  <div class="container">
    <h2>Destination City:</h2>

    <div class="row">
      <div class="input-field col s6">
        <input id="city-input" type="text" class="validate" />
      </div>
    </div>
    <button id="submitBtn" class="btn waves-effect waves-light" type="submit" name="action">
      Search
      <i class="material-icons right">send</i>
    </button>
  </div>


  <!--div area where information from API's will appear-->
  <div id="yelpArea"></div>
  <div id="youTubeArea"></div>
  <iframe src=""></iframe>

  <!--itinerary table container-->
  <div id="itineraryArea" class="container">
    <div class="row">
      <div class="col-md-12">
        <div class="card text-white border-danger mb-4">
          <h5 class="card-header bg-danger">Current Itinerary</h5>
          <div class="card-body text-danger">
            <table class="table table-sm table-hover" id='itinerary-table'>
              <thead class="thead-light">
                <tr>
                  <th scope="col">Restaurant</th>
                  <th scope="col">Phone Number</th>
                  <th scope="col">Address</th>
                  <th scope="col">City</th>
                  <th scope="col">State</th>
                  <th scope="col">Zip Code</th>
                  <th scope="col">Delete</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>


    <script src="https://code.jquery.com/jquery.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>



      $(document).ready(function () {

        $('iframe').hide();

        //function that adds itinerary row to the table
        function renderItineraries(itineraries) {
          $('#itinerary-table tbody').empty();

          for (var i = 0; i < itineraries.length; i++) {
            var newRow = $("<tr>").append(
              $("<td>").text(itineraries[i].name),
              $("<td>").text(itineraries[i].phone),
              $("<td>").text(itineraries[i].address),
              $("<td>").text(itineraries[i].city),
              $("<td>").text(itineraries[i].state),
              $("<td>").text(itineraries[i].zipCode));

            var deleteButton = $("<button>");
            deleteButton.attr("data-itinerary", i)
              .attr("type", "delete")
              .addClass("deleteButton")
              .text("Delete");

            newRow = newRow.append(deleteButton);
            $("#itinerary-table").append(newRow);
          }
        }
        //creates a variable that stores and parses information from localStorage
        var itineraries = JSON.parse(localStorage.getItem("itineraries"));

        //if statement that says if there is nothing in the variable itineraries, 
        //then the the itineraries array will be empty
        if (!itineraries) {
          itineraries = [];
        }
        //calls renderItineraries function
        renderItineraries(itineraries);

        $("#submitBtn").on("click", function (event) {
          event.preventDefault();

          $("#yelpArea").html("");

          cityName = $("#city-input")
            .val()
            .trim();

          $('iframe').show();

          $.ajax({
            url:
              "https://cors-anywhere.herokuapp.com/https://api.yelp.com/v3/businesses/search",
            method: "GET",
            error: function (error) {
              console.log("error", error);
            },
            headers: {
              Authorization:
                "Bearer 777OVHyUQXu4MD9WPwXQ3dub9jGslCwGt185TfYEQF6JoBa7tr7kjVe7OvbcNzwp2mY8k3JkODi2curLYOzJsG5dKxmQD8SzDYABjKEzUGC8i3Bk4vXHaU6P5G5DXnYx"
            },
            dataType: "json",
            data: { term: "restaurant", location: cityName, limit: "5" }



          }).then(function (response) {

            console.log(response);


            var totalresults = response.total;

            if (totalresults > 0) {


              $.each(response.businesses, function (i, item) {


                //I made a bunch of changes here with the attributes
                var restaurantDiv = $("<div>")
                  .addClass("restaurant")
                  .attr("name-val", item.name)
                  .attr("phone-val", item.display_phone)
                  .attr("address-val", item.location.address1)
                  .attr("city-val", item.location.city)
                  .attr("state-val", item.location.state)
                  .attr("zip-val", item.location.zip_code);
                var image = $("<img>");
                image.attr("src", item.image_url)
                  .addClass("image")
                  .attr("style", "width:200px; height:150px; margin-top:50px");
                var name = $("<p>")
                  .addClass("name")
                  .html("We found " + item.name.bold());
                var address = $("<p>")
                  .addClass("address")
                  .attr("style", "margin-top:-15px")
                  .html(item.location.address1 + " " + item.location.city + " " + item.location.state + " " + item.location.zip_code);
                var phone = $("<p>")
                  .addClass("phone")
                  .attr("style", "margin-top:-15px")
                  .html("The phone number for this business is: " + item.display_phone);
                var ratingWithReviewCount = $("<p>")
                  .addClass("ratingWithReviewCount")
                  .attr("style", "margin-top:-15px")
                  .html("This business has a rating of " + item.rating + " with " + item.review_county + " reviews.");

                restaurantDiv.append(image);
                restaurantDiv.append(name);
                restaurantDiv.append(address);
                restaurantDiv.append(phone);
                restaurantDiv.append(ratingWithReviewCount);
                $("#yelpArea").append(restaurantDiv);
                //copy-paste down to here from the restaurantDiv, just in case

              });
            } else {

              $("#yelpArea").append("<h5>We discovered no results!</h5>");
            }
          });

          $.ajax({
            type: 'GET',
            url: 'https://www.googleapis.com/youtube/v3/search',
            data: {
              key: 'AIzaSyA5QGk0Aszi91ubsph31l_NmGzzct6vL9s',
              q: cityName,
              part: 'snippet',
              maxResults: 1,
              type: 'video',
              chart: 'mostPopular',
              videoEmbeddable: true,
            },
            error: function (response) {
              $("youTubeArea").append("<h5>Request Failed</h5>");
            }
          }).then(function (response) {
            console.log(response);

            $('iframe').attr('src', 'https://www.youtube.com/embed/' + response.items[0].id.videoId);
            $("#youTubeArea").append("<h3>" + response.items[0].snippet.title + "</h3>")
              .append("<p>" + response.items[0].snippet.description + "</p>");

          });
        });
        //created function to add to itinerary on table and localStorage
        function addToItinerary() {

          var name = $(this).attr("name-val");
          var phone = $(this).attr("phone-val");
          var address = $(this).attr("address-val");
          var city = $(this).attr("city-val");
          var state = $(this).attr("state-val");
          var zipCode = $(this).attr("zip-val");

          var itinerary = {
            name: name,
            phone: phone,
            address: address,
            city: city,
            state: state,
            zipCode: zipCode
          }

          itineraries.push(itinerary);

          renderItineraries(itineraries);

          localStorage.setItem("itineraries", JSON.stringify(itineraries));

        };

        //clicking on the restaurant div adds to the itinerary table and storage
        $(document).on("click", ".restaurant", addToItinerary);

        //clicking on the delete button in a row of the table deletes
        //row on table and element in local storage
        $(document).on("click", ".deleteButton", function () {
          event.preventDefault();

          var toDoNumber = $(this).attr("data-itinerary");

          itineraries.splice(toDoNumber, 1);

          renderItineraries(itineraries);
          localStorage.setItem("itineraries", JSON.stringify(itineraries));
        })

      });

    </script>
</body>

</html>